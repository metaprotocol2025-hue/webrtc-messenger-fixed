<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Messenger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            min-height: 100vh;
        }

        .video-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
        }

        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-wrapper {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16/9;
        }

        .video-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.danger {
            background: #f44336;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .btn.danger:hover {
            background: #da190b;
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        .room-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .room-input input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .room-input input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .room-input input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
        }

        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-weight: 600;
        }

        .status.connected {
            background: rgba(76, 175, 80, 0.3);
        }

        .status.error {
            background: rgba(244, 67, 54, 0.3);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            max-height: 400px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            word-wrap: break-word;
        }

        .message .username {
            font-weight: bold;
            color: #4CAF50;
            margin-right: 5px;
        }

        .message .timestamp {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            float: right;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .chat-input input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .chat-input input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
        }

        .users-list {
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .users-list h3 {
            margin-bottom: 10px;
            color: #4CAF50;
        }

        .user-item {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .call-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .call-btn:hover {
            background: #1976D2;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .video-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="video-section">
            <div class="room-input">
                <input type="text" id="roomInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" value="room1">
                <input type="text" id="usernameInput" placeholder="–í–∞—à–µ –∏–º—è" value="User">
                <button class="btn" id="joinBtn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
            
            <div class="status" id="status">–û—Ç–∫–ª—é—á–µ–Ω</div>
            
            <div class="video-container">
                <div class="video-wrapper">
                    <video id="localVideo" autoplay muted playsinline></video>
                    <div class="video-label">–í—ã</div>
                </div>
                <div class="video-wrapper">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <div class="video-label">–°–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" id="callBtn" disabled>–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
                <button class="btn danger" id="endCallBtn" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                <button class="btn" id="muteBtn" disabled>üîá –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
                <button class="btn" id="videoBtn" disabled>üìπ –í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ</button>
            </div>
        </div>
        
        <div class="chat-section">
            <div class="users-list" id="usersList">
                <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–Ω–∞—Ç—ã</h3>
                <div id="usersContainer"></div>
            </div>
            
            <div class="chat-messages" id="chatMessages"></div>
            
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                <button class="btn" id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        class WebRTCMessenger {
            constructor() {
                this.socket = null;
                this.localStream = null;
                this.remoteStream = null;
                this.peerConnection = null;
                this.roomId = null;
                this.username = null;
                this.isConnected = false;
                this.isMuted = false;
                this.isVideoOff = false;
                this.currentCall = null;

                this.initializeElements();
                this.setupEventListeners();
            }

            initializeElements() {
                this.roomInput = document.getElementById('roomInput');
                this.usernameInput = document.getElementById('usernameInput');
                this.joinBtn = document.getElementById('joinBtn');
                this.status = document.getElementById('status');
                this.localVideo = document.getElementById('localVideo');
                this.remoteVideo = document.getElementById('remoteVideo');
                this.callBtn = document.getElementById('callBtn');
                this.endCallBtn = document.getElementById('endCallBtn');
                this.muteBtn = document.getElementById('muteBtn');
                this.videoBtn = document.getElementById('videoBtn');
                this.usersContainer = document.getElementById('usersContainer');
                this.chatMessages = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
            }

            setupEventListeners() {
                this.joinBtn.addEventListener('click', () => this.joinRoom());
                this.callBtn.addEventListener('click', () => this.startCall());
                this.endCallBtn.addEventListener('click', () => this.endCall());
                this.muteBtn.addEventListener('click', () => this.toggleMute());
                this.videoBtn.addEventListener('click', () => this.toggleVideo());
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            }

            async joinRoom() {
                const roomId = this.roomInput.value.trim();
                const username = this.usernameInput.value.trim();

                if (!roomId || !username) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã –∏ –≤–∞—à–µ –∏–º—è');
                    return;
                }

                this.roomId = roomId;
                this.username = username;

                try {
                    // Get user media
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });

                    this.localVideo.srcObject = this.localStream;
                    this.updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ...', 'connecting');

                    // Connect to signaling server
                    this.socket = io();
                    this.setupSocketListeners();

                    this.socket.emit('join-room', roomId, username);

                } catch (error) {
                    console.error('Error accessing media devices:', error);
                    this.updateStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.');
                }
            }

            setupSocketListeners() {
                this.socket.on('room-joined', (data) => {
                    console.log('Joined room:', data);
                    this.updateStatus(`–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –∫–æ–º–Ω–∞—Ç–µ: ${data.roomId}`, 'connected');
                    this.updateUsersList(data.users);
                    this.loadChatHistory(data.messages);
                    this.enableControls();
                });

                this.socket.on('user-joined', (user) => {
                    console.log('User joined:', user);
                    this.addUserToList(user);
                    this.addSystemMessage(`${user.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ`);
                });

                this.socket.on('user-left', (user) => {
                    console.log('User left:', user);
                    this.removeUserFromList(user.socketId);
                    this.addSystemMessage(`${user.username} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`);
                });

                this.socket.on('chat-message', (message) => {
                    this.addChatMessage(message);
                });

                this.socket.on('offer', async (data) => {
                    console.log('Received offer:', data);
                    await this.handleOffer(data);
                });

                this.socket.on('answer', async (data) => {
                    console.log('Received answer:', data);
                    await this.handleAnswer(data);
                });

                this.socket.on('ice-candidate', async (data) => {
                    console.log('Received ICE candidate:', data);
                    await this.handleIceCandidate(data);
                });

                this.socket.on('incoming-call', (data) => {
                    console.log('Incoming call:', data);
                    this.handleIncomingCall(data);
                });

                this.socket.on('call-accepted', (data) => {
                    console.log('Call accepted:', data);
                    this.handleCallAccepted(data);
                });

                this.socket.on('call-rejected', (data) => {
                    console.log('Call rejected:', data);
                    this.handleCallRejected(data);
                });

                this.socket.on('call-ended', (data) => {
                    console.log('Call ended:', data);
                    this.handleCallEnded(data);
                });
            }

            async startCall() {
                if (!this.socket || !this.localStream) return;

                try {
                    this.peerConnection = this.createPeerConnection();
                    this.localStream.getTracks().forEach(track => {
                        this.peerConnection.addTrack(track, this.localStream);
                    });

                    const offer = await this.peerConnection.createOffer();
                    await this.peerConnection.setLocalDescription(offer);

                    // Send offer to all other users in the room
                    this.socket.emit('offer', {
                        offer: offer,
                        target: 'all'
                    });

                    this.updateStatus('–ó–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω...', 'connecting');
                    this.callBtn.disabled = true;
                    this.endCallBtn.disabled = false;

                } catch (error) {
                    console.error('Error starting call:', error);
                    this.updateStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∞', 'error');
                }
            }

            createPeerConnection() {
                const configuration = {
                    iceServers: [
                        { urls: "stun:stun.l.google.com:19302" },
                        { urls: "stun:stun1.l.google.com:19302" },
                        {
                            urls: "turn:relay.metered.ca:80",
                            username: "demo",
                            credential: "demo"
                        },
                        {
                            urls: "turn:relay.metered.ca:443",
                            username: "demo",
                            credential: "demo"
                        }
                    ]
                };

                const pc = new RTCPeerConnection(configuration);

                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        this.socket.emit('ice-candidate', {
                            candidate: event.candidate,
                            target: 'all'
                        });
                    }
                };

                pc.ontrack = (event) => {
                    console.log('Received remote stream');
                    this.remoteStream = event.streams[0];
                    this.remoteVideo.srcObject = this.remoteStream;
                    this.updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'connected');
                };

                pc.onconnectionstatechange = () => {
                    console.log('Connection state:', pc.connectionState);
                    if (pc.connectionState === 'connected') {
                        this.updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'connected');
                    } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                        this.updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ', 'error');
                    }
                };

                return pc;
            }

            async handleOffer(data) {
                if (!this.peerConnection) {
                    this.peerConnection = this.createPeerConnection();
                    this.localStream.getTracks().forEach(track => {
                        this.peerConnection.addTrack(track, this.localStream);
                    });
                }

                await this.peerConnection.setRemoteDescription(data.offer);
                const answer = await this.peerConnection.createAnswer();
                await this.peerConnection.setLocalDescription(answer);

                this.socket.emit('answer', {
                    answer: answer,
                    target: data.sender
                });
            }

            async handleAnswer(data) {
                if (this.peerConnection) {
                    await this.peerConnection.setRemoteDescription(data.answer);
                }
            }

            async handleIceCandidate(data) {
                if (this.peerConnection) {
                    await this.peerConnection.addIceCandidate(data.candidate);
                }
            }

            endCall() {
                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                }

                this.remoteVideo.srcObject = null;
                this.remoteStream = null;

                this.callBtn.disabled = false;
                this.endCallBtn.disabled = true;

                this.updateStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω', 'connected');
            }

            toggleMute() {
                if (this.localStream) {
                    const audioTrack = this.localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.enabled = !audioTrack.enabled;
                        this.isMuted = !audioTrack.enabled;
                        this.muteBtn.textContent = this.isMuted ? 'üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫' : 'üîá –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
                    }
                }
            }

            toggleVideo() {
                if (this.localStream) {
                    const videoTrack = this.localStream.getVideoTracks()[0];
                    if (videoTrack) {
                        videoTrack.enabled = !videoTrack.enabled;
                        this.isVideoOff = !videoTrack.enabled;
                        this.videoBtn.textContent = this.isVideoOff ? 'üìπ –í–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ' : 'üìπ –í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ';
                    }
                }
            }

            updateStatus(message, type = '') {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
            }

            updateUsersList(users) {
                this.usersContainer.innerHTML = '';
                users.forEach(user => {
                    this.addUserToList(user);
                });
            }

            addUserToList(user) {
                const userElement = document.createElement('div');
                userElement.className = 'user-item';
                userElement.id = `user-${user.socketId}`;
                userElement.innerHTML = `
                    <span>${user.username}</span>
                    ${user.socketId !== this.socket.id ? 
                        `<button class="call-btn" onclick="messenger.callUser('${user.socketId}')">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>` : 
                        '<span style="color: #4CAF50;">–í—ã</span>'
                    }
                `;
                this.usersContainer.appendChild(userElement);
            }

            removeUserFromList(socketId) {
                const userElement = document.getElementById(`user-${socketId}`);
                if (userElement) {
                    userElement.remove();
                }
            }

            callUser(targetSocketId) {
                this.socket.emit('call-user', { target: targetSocketId });
            }

            handleIncomingCall(data) {
                if (confirm(`–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ${data.callerName}. –ü—Ä–∏–Ω—è—Ç—å?`)) {
                    this.socket.emit('call-accepted', { caller: data.caller });
                    this.startCall();
                } else {
                    this.socket.emit('call-rejected', { caller: data.caller });
                }
            }

            handleCallAccepted(data) {
                this.updateStatus('–ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç', 'connected');
            }

            handleCallRejected(data) {
                this.updateStatus('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω', 'error');
                this.callBtn.disabled = false;
                this.endCallBtn.disabled = true;
            }

            handleCallEnded(data) {
                this.endCall();
            }

            enableControls() {
                this.messageInput.disabled = false;
                this.sendBtn.disabled = false;
                this.callBtn.disabled = false;
                this.muteBtn.disabled = false;
                this.videoBtn.disabled = false;
            }

            sendMessage() {
                const message = this.messageInput.value.trim();
                if (message && this.socket) {
                    this.socket.emit('chat-message', { message });
                    this.messageInput.value = '';
                }
            }

            addChatMessage(message) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.innerHTML = `
                    <span class="username">${message.username}:</span>
                    <span>${message.message}</span>
                    <span class="timestamp">${new Date(message.timestamp).toLocaleTimeString()}</span>
                `;
                this.chatMessages.appendChild(messageElement);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            addSystemMessage(message) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.style.background = 'rgba(76, 175, 80, 0.3)';
                messageElement.innerHTML = `
                    <span>${message}</span>
                    <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                `;
                this.chatMessages.appendChild(messageElement);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            loadChatHistory(messages) {
                messages.forEach(message => {
                    this.addChatMessage(message);
                });
            }
        }

        // Initialize the messenger when the page loads
        let messenger;
        window.addEventListener('load', () => {
            messenger = new WebRTCMessenger();
        });
    </script>
</body>
</html>
