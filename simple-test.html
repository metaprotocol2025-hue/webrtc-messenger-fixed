<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simple WebRTC Test</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      color: white;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
    }
    video {
      width: 100%;
      max-width: 300px;
      background: #000;
      border-radius: 10px;
      margin: 10px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 15px 30px;
      margin: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      background: rgba(0,0,0,0.3);
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .log {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîí Simple WebRTC Test</h1>
    
    <div class="status" id="status">–û—Ç–∫–ª—é—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞</div>
    
    <div>
      <input type="text" id="usernameInput" placeholder="–í–∞—à–µ –∏–º—è" value="USER1">
      <button onclick="setUsername()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–º—è</button>
    </div>
    
    <div>
      <input type="text" id="roomInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" value="test-room">
      <button onclick="joinRoom()">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
    </div>
    
    <div>
      <button onclick="startCall()" id="startBtn">–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
      <button onclick="endCall()" id="endBtn" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
    </div>
    
    <div>
      <video id="localVideo" autoplay muted></video>
      <video id="remoteVideo" autoplay></video>
    </div>
    
    <div class="log" id="log"></div>
  </div>

  <script>
    let socket = null;
    let localStream = null;
    let peerConnection = null;
    let username = null;
    let roomId = null;
    let isConnected = false;

    function log(message) {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${time}] ${message}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function setUsername() {
      username = document.getElementById('usernameInput').value.trim();
      if (!username) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
        return;
      }
      log(`–ò–º—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${username}`);
      connectSocket();
    }

    function connectSocket() {
      log('–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É...');
      socket = io("/", { 
        transports: ["websocket", "polling"],
        timeout: 20000
      });

      socket.on('connect', () => {
        log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É');
        document.getElementById('status').textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É';
        isConnected = true;
      });

      socket.on('disconnect', () => {
        log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
        document.getElementById('status').textContent = '‚ùå –û—Ç–∫–ª—é—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞';
        isConnected = false;
      });

      socket.on('user-joined', (data) => {
        log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è: ${data.username}`);
      });

      socket.on('user-left', (data) => {
        log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª: ${data.username}`);
      });

      socket.on('offer', async (data) => {
        log(`–ü–æ–ª—É—á–µ–Ω offer –æ—Ç ${data.senderName}`);
        try {
          if (!peerConnection) {
            setupPeerConnection();
          }
          await peerConnection.setRemoteDescription(data.offer);
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          
          socket.emit('answer', {
            target: data.sender,
            answer: answer
          });
          log('Answer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
        } catch (error) {
          log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ offer: ${error.message}`);
        }
      });

      socket.on('answer', async (data) => {
        log(`–ü–æ–ª—É—á–µ–Ω answer –æ—Ç ${data.senderName}`);
        try {
          await peerConnection.setRemoteDescription(data.answer);
        } catch (error) {
          log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ answer: ${error.message}`);
        }
      });

      socket.on('ice-candidate', async (data) => {
        log(`–ü–æ–ª—É—á–µ–Ω ICE candidate –æ—Ç ${data.senderName}`);
        try {
          if (peerConnection) {
            await peerConnection.addIceCandidate(data.candidate);
          }
        } catch (error) {
          log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ICE candidate: ${error.message}`);
        }
      });
    }

    function joinRoom() {
      if (!isConnected) {
        alert('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
        return;
      }

      roomId = document.getElementById('roomInput').value.trim();
      if (!roomId) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã');
        return;
      }

      socket.emit('join-room', roomId, username);
      log(`–í–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É: ${roomId}`);
    }

    async function startCall() {
      try {
        log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
        localStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        });
        
        document.getElementById('localVideo').srcObject = localStream;
        log('‚úÖ –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω');
        
        setupPeerConnection();
        
        document.getElementById('startBtn').disabled = true;
        document.getElementById('endBtn').disabled = false;
        
        log('–ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç');
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ${error.message}`);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
      }
    }

    function setupPeerConnection() {
      log('–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
      
      const configuration = {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' },
          { urls: 'stun:stun2.l.google.com:19302' }
        ]
      };

      peerConnection = new RTCPeerConnection(configuration);

      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º ICE candidate');
          socket.emit('ice-candidate', {
            target: 'all',
            candidate: event.candidate
          });
        } else {
          log('ICE gathering –∑–∞–≤–µ—Ä—à–µ–Ω');
        }
      };

      peerConnection.ontrack = (event) => {
        log('‚úÖ –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫!');
        document.getElementById('remoteVideo').srcObject = event.streams[0];
      };

      peerConnection.onconnectionstatechange = () => {
        log(`–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${peerConnection.connectionState}`);
        if (peerConnection.connectionState === 'connected') {
          log('üéâ WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
        }
      };

      peerConnection.oniceconnectionstatechange = () => {
        log(`ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${peerConnection.iceConnectionState}`);
      };

      if (localStream) {
        localStream.getTracks().forEach(track => {
          peerConnection.addTrack(track, localStream);
        });
        log('–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ peer connection');
      }

      createOffer();
    }

    async function createOffer() {
      try {
        log('–°–æ–∑–¥–∞–µ–º offer...');
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        
        socket.emit('offer', {
          target: 'all',
          offer: offer
        });
        log('‚úÖ Offer –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer: ${error.message}`);
      }
    }

    function endCall() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }

      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }

      document.getElementById('localVideo').srcObject = null;
      document.getElementById('remoteVideo').srcObject = null;

      document.getElementById('startBtn').disabled = false;
      document.getElementById('endBtn').disabled = true;

      log('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = function() {
      setUsername();
    };
  </script>
</body>
</html>


