#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ coturn Ð½Ð° Ubuntu 22.04
# ÐÐ²Ñ‚Ð¾Ñ€: WebRTC Messenger Setup
# Ð’ÐµÑ€ÑÐ¸Ñ: 1.0

set -e

echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ coturn TURN-ÑÐµÑ€Ð²ÐµÑ€Ð°..."

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ..."
sudo apt update && sudo apt upgrade -y

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ coturn
echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ coturn..."
sudo apt install -y coturn

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ IP ÑÐµÑ€Ð²ÐµÑ€Ð°
EXTERNAL_IP=$(curl -s ifconfig.me)
echo "ðŸŒ Ð’Ð½ÐµÑˆÐ½Ð¸Ð¹ IP ÑÐµÑ€Ð²ÐµÑ€Ð°: $EXTERNAL_IP"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ coturn
echo "âš™ï¸ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ coturn..."
sudo tee /etc/turnserver.conf > /dev/null <<EOF
# TURN Server Configuration
# Generated by WebRTC Messenger Setup

# ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
listening-port=3478
tls-listening-port=5349
listening-ip=0.0.0.0
external-ip=$EXTERNAL_IP

# ÐÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ
user=webrtc:strongpassword
realm=myturn.local

# Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
fingerprint
lt-cred-mech

# Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
log-file=/var/log/turn.log
verbose

# ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
total-quota=100
bps-capacity=0
stale-nonce=600

# Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
no-multicast-peers
no-cli
no-tlsv1
no-tlsv1_1

# Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
no-dtls
no-tls
EOF

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¾Ð²
sudo mkdir -p /var/log
sudo touch /var/log/turn.log
sudo chown turnserver:turnserver /var/log/turn.log

# Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº
echo "ðŸ”„ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº..."
sudo systemctl enable coturn
sudo systemctl start coturn

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ coturn..."
sudo systemctl status coturn --no-pager

# ÐžÑ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾Ñ€Ñ‚Ñ‹ Ð² UFW
echo "ðŸ”¥ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»..."
sudo ufw allow 3478/udp
sudo ufw allow 5349/tcp
sudo ufw allow 443/tcp
sudo ufw --force enable

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÐµÑ€Ð²ÐµÑ€ ÑÐ»ÑƒÑˆÐ°ÐµÑ‚ Ð¿Ð¾Ñ€Ñ‚Ñ‹
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð¿Ð¾Ñ€Ñ‚Ñ‹..."
sudo netstat -tulpn | grep -E ":(3478|5349)"

echo ""
echo "ðŸŽ‰ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° coturn Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo ""
echo "ðŸ“‹ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ðµ:"
echo "   IP Ð°Ð´Ñ€ÐµÑ: $EXTERNAL_IP"
echo "   TURN Ð¿Ð¾Ñ€Ñ‚: 3478 (UDP)"
echo "   TLS Ð¿Ð¾Ñ€Ñ‚: 5349 (TCP)"
echo "   ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: webrtc"
echo "   ÐŸÐ°Ñ€Ð¾Ð»ÑŒ: strongpassword"
echo "   Realm: myturn.local"
echo ""
echo "ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:"
echo "   telnet $EXTERNAL_IP 3478"
echo "   telnet $EXTERNAL_IP 5349"
echo ""
echo "ðŸ“ Ð›Ð¾Ð³Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð°:"
echo "   sudo tail -f /var/log/turn.log"
echo ""
echo "ðŸ› ï¸ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð¼:"
echo "   sudo systemctl status coturn"
echo "   sudo systemctl restart coturn"
echo "   sudo systemctl stop coturn"
echo ""
echo "âœ… TURN-ÑÐµÑ€Ð²ÐµÑ€ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ!"


